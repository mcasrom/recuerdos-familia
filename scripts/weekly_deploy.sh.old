#!/usr/bin/env bash
# =============================================================================
# Deployment automático semanal - Álbum Familiar (Hugo → GitHub Pages)
# Ejecutar preferiblemente desde crontab o manualmente con:
#   cd ~/album_familiar && ~/album_familiar/scripts/weekly_deploy.sh
# =============================================================================

set -euo pipefail

# ─── Configuración ────────────────────────────────────────────────────────────
readonly PROJECT_DIR="$HOME/album_familiar"
readonly LOG_DIR="$HOME/album_familiar/logs"
readonly LOG_FILE="$LOG_DIR/weekly_deploy.log"
readonly BACKUP_DIR="/mnt/backup"
readonly BASE_URL="https://mcasrom.github.io/recuerdos-familia/"

readonly DATE=$(date '+%Y-%m-%d %H:%M:%S')
readonly TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
readonly BACKUP_FILE="$BACKUP_DIR/album_familiar_auto_${TIMESTAMP}.tar.gz"

# ─── Funciones auxiliares ─────────────────────────────────────────────────────
log() {
    echo "[$DATE] $*" >> "$LOG_FILE"
}

log_error() {
    echo "[$DATE] ERROR: $*" >> "$LOG_FILE" >&2
}

section() {
    log "────────────────────────────────────────"
    log "$*"
    log "────────────────────────────────────────"
}

check_requirements() {
    local cmd missing=()
    for cmd in git hugo tar; do
        command -v "$cmd" >/dev/null 2>&1 || missing+=("$cmd")
    done

    if ((${#missing[@]} > 0)); then
        log_error "Faltan programas: ${missing[*]}"
        exit 9
    fi
}

ensure_directories() {
    mkdir -p "$LOG_DIR" "$BACKUP_DIR" || {
        log_error "No se pudieron crear directorios necesarios"
        exit 10
    }
}

create_backup() {
    if [[ ! -d "$BACKUP_DIR" ]]; then
        log "Directorio de backup no existe → se omite"
        return 0
    fi

    log "Creando backup → $BACKUP_FILE"

    tar -czf "$BACKUP_FILE" \
        --exclude='./public' \
        --exclude='./resources' \
        --exclude='./.git' \
        --exclude='./node_modules' \
        -C "$HOME" album_familiar 2>>"$LOG_FILE"

    if [[ $? -eq 0 ]]; then
        log "Backup creado correctamente"
        # Limpiar backups > 35 días
        find "$BACKUP_DIR" -type f -name "album_familiar_auto_*.tar.gz" -mtime +35 -delete 2>/dev/null || true
    else
        log_error "Fallo al crear backup"
        return 1
    fi
}

main() {
    section "Inicio deployment semanal"

    check_requirements
    ensure_directories

    if ! cd "$PROJECT_DIR" 2>/dev/null; then
        log_error "No se puede entrar a $PROJECT_DIR"
        exit 1
    fi

    log "Directorio de trabajo: $(pwd)"

    # Verificar si realmente es un repositorio git
    if [[ ! -d ".git" ]]; then
        log_error "No se encontró repositorio .git en $(pwd)"
        exit 2
    fi

    create_backup || true   # backup no crítico → continuamos aunque falle

    # ─── Git workflow ───────────────────────────────────────────────────────
    log "Verificando cambios..."

    if git status --porcelain | grep -q .; then
        log "Se detectaron cambios"

        log "Generando sitio con Hugo..."
        if ! hugo --cleanDestinationDir --baseURL "$BASE_URL" >>"$LOG_FILE" 2>&1; then
            log_error "Fallo al ejecutar hugo"
            exit 3
        fi

        log "Agregando archivos..."
        git add -A . >>"$LOG_FILE" 2>&1 || true

        log "Creando commit..."
        git commit -m "Auto-deploy semanal: $DATE" >>"$LOG_FILE" 2>&1 || {
            log "No hay nada que commitear después de hugo (posiblemente solo cambios ignorados)"
        }

        log "Haciendo push..."
        if git push >>"$LOG_FILE" 2>&1; then
            log "✓ Push exitoso"
        else
            log_error "✗ Falló el push a GitHub"
            exit 4
        fi
    else
        log "No hay cambios pendientes → fin"
    fi

    section "Proceso finalizado correctamente"
    log ""
}

# ─── Ejecución principal ──────────────────────────────────────────────────────
{
    main
} >>"$LOG_FILE" 2>&1

exit 0
