#+TITLE: √Ålbum Familiar - Correcciones Finales y Lecciones Aprendidas
#+AUTHOR: Sesi√≥n de Depuraci√≥n y Optimizaci√≥n
#+DATE: [2026-02-15 S√°b]
#+DESCRIPTION: Documentaci√≥n de problemas encontrados y soluciones aplicadas
#+KEYWORDS: debugging, troubleshooting, thumbnails, taxonom√≠as, github-pages
#+LANGUAGE: es
#+STARTUP: overview indent
#+OPTIONS: toc:2 num:t ^:nil

* RESUMEN EJECUTIVO

Durante la fase de implementaci√≥n y despliegue del √°lbum familiar, se encontraron y resolvieron varios problemas cr√≠ticos relacionados con:

1. Autenticaci√≥n SHA-256 en HTTP
2. Rutas de assets en GitHub Pages con subdirectorio
3. Visualizaci√≥n de thumbnails
4. Taxonom√≠as de a√±os y meses
5. Formato de im√°genes (JPG/PNG)

Este documento registra cada problema, su causa ra√≠z y la soluci√≥n implementada para referencia futura.

* PROBLEMA 1: Autenticaci√≥n No Funcionaba en HTTP

** S√≠ntoma
:PROPERTIES:
:CUSTOM_ID: auth-http-problem
:END:

#+BEGIN_QUOTE
Password ingresado correctamente pero no pasa de la pantalla de login.
Error en consola: ~crypto.subtle is undefined~
#+END_QUOTE

** Causa Ra√≠z

La API ~crypto.subtle~ de JavaScript **solo funciona en contextos seguros**:
- ‚úÖ HTTPS (producci√≥n)
- ‚úÖ localhost
- ‚ùå HTTP con IP (desarrollo remoto)

** Soluci√≥n Implementada

Reemplazar la implementaci√≥n basada en ~crypto.subtle~ por una **implementaci√≥n SHA-256 pura en JavaScript**:

#+BEGIN_SRC javascript
// ANTES (no funcionaba en HTTP)
async function sha256(message) {
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    // ...
}

// DESPU√âS (funciona en HTTP y HTTPS)
function sha256(str) {
    const utf8 = unescape(encodeURIComponent(str));
    const bytes = [];
    for (let i = 0; i < utf8.length; i++) {
        bytes.push(utf8.charCodeAt(i));
    }
    // Implementaci√≥n SHA-256 completa sin crypto.subtle
    // ...
}
#+END_SRC

** Archivo Modificado

- ~static/js/auth.js~ (l√≠neas 12-88)

** Lecci√≥n Aprendida

#+BEGIN_QUOTE
‚ö†Ô∏è Siempre implementar fallbacks para APIs del navegador que requieren contextos seguros cuando se necesita desarrollo en HTTP.
#+END_QUOTE

* PROBLEMA 2: CSS y JS No Cargaban en GitHub Pages

** S√≠ntoma

#+BEGIN_QUOTE
En producci√≥n (GitHub Pages): Login a la izquierda, p√°gina en blanco, CSS y JS no cargan.
En local: Todo funciona perfectamente.
#+END_QUOTE

** Causa Ra√≠z

GitHub Pages sirve el sitio en un subdirectorio: ~https://usuario.github.io/repo/~

Las rutas relativas ~/css/style.css~ se resolv√≠an a:
- Local: ~http://localhost:1313/css/style.css~ ‚úÖ
- GitHub: ~https://usuario.github.io/css/style.css~ ‚ùå

Faltaba el prefijo ~/repo/~

** Intentos Fallidos

| Intento | M√©todo | Resultado |
|---------+--------+-----------|
| 1       | ~relURL~ filter | Hugo no lo aplicaba correctamente |
| 2       | Rutas relativas | Mismo problema |

** Soluci√≥n Final

Usar ~.Site.BaseURL~ concatenado manualmente en los templates:

#+BEGIN_SRC html
<!-- ANTES (incorrecto) -->
<link rel="stylesheet" href="/css/style.css">
<script src="/js/auth.js"></script>

<!-- DESPU√âS (correcto) -->
<link rel="stylesheet" href="{{ .Site.BaseURL }}css/style.css">
<script src="{{ .Site.BaseURL }}js/auth.js"></script>
#+END_SRC

** Archivos Modificados

- ~layouts/_default/baseof.html~ (l√≠neas 7, 18-20)
- ~config.toml~ (l√≠nea 1)

** Configuraci√≥n Dual

Para desarrollo local vs producci√≥n:

#+BEGIN_SRC bash
# Local (sin baseURL)
hugo server --baseURL ""

# Producci√≥n (con baseURL completo)
hugo --baseURL "https://mcasrom.github.io/recuerdos-familia/"
#+END_SRC

** Lecci√≥n Aprendida

#+BEGIN_QUOTE
üéØ GitHub Pages con subdirectorios requiere URLs absolutas con ~.Site.BaseURL~. El filtro ~relURL~ no siempre funciona como se espera.
#+END_QUOTE

* PROBLEMA 3: Thumbnails No Se Mostraban

** S√≠ntoma

#+BEGIN_QUOTE
- P√°gina principal: Miniaturas en blanco
- A√±os/Meses: Solo iconos, sin fotos
- Fotos individuales: ‚úÖ Funcionaban correctamente
#+END_QUOTE

** Causa Ra√≠z M√∫ltiple

*** Subcausa 3.1: Rutas con Barra Inicial

Los thumbnails en el frontmatter ten√≠an:

#+BEGIN_SRC yaml
thumbnail: "/images/2026/02/foto_xxx_thumb.jpg"
#+END_SRC

Al concatenar con ~.Site.BaseURL~:

#+BEGIN_SRC
https://mcasrom.github.io/recuerdos-familia//images/...
                                         ^^
                                   Doble barra!
#+END_SRC

*** Subcausa 3.2: Template Incorrecto

El ~list.html~ original no iteraba sobre las fotos, sino que mostraba la secci√≥n como p√°gina √∫nica.

** Soluci√≥n Implementada

*** Fix 3.1: Remover Barra Inicial

#+BEGIN_SRC go-html-template
{{ $thumb := strings.TrimPrefix "/" .Params.thumbnail }}
<img src="{{ $.Site.BaseURL }}{{ $thumb }}" ...>
#+END_SRC

*** Fix 3.2: Templates Espec√≠ficos por Secci√≥n

Crear layouts espec√≠ficos:

#+BEGIN_SRC
layouts/
‚îú‚îÄ‚îÄ index.html              # P√°gina principal (primeras 20 fotos)
‚îú‚îÄ‚îÄ fotos/
‚îÇ   ‚îî‚îÄ‚îÄ list.html          # Lista todas las fotos
‚îú‚îÄ‚îÄ years/
‚îÇ   ‚îú‚îÄ‚îÄ list.html          # Lista de a√±os
‚îÇ   ‚îî‚îÄ‚îÄ single.html        # Fotos de un a√±o espec√≠fico
‚îî‚îÄ‚îÄ months/
    ‚îú‚îÄ‚îÄ list.html          # Lista de meses
    ‚îî‚îÄ‚îÄ single.html        # Fotos de un mes espec√≠fico
#+END_SRC

** Archivos Creados/Modificados

- ~layouts/index.html~ (NUEVO)
- ~layouts/fotos/list.html~ (NUEVO)
- ~layouts/_default/list.html~ (MODIFICADO)
- ~layouts/years/single.html~ (MODIFICADO)
- ~layouts/months/single.html~ (MODIFICADO)

** Lecci√≥n Aprendida

#+BEGIN_QUOTE
üì∏ Hugo necesita templates espec√≠ficos por secci√≥n cuando la estructura de contenido es diferente. El ~_default/list.html~ solo sirve como fallback.
#+END_QUOTE

* PROBLEMA 4: Taxonom√≠as Vac√≠as (A√±os y Meses)

** S√≠ntoma

#+BEGIN_QUOTE
Al hacer clic en "Por A√±o" o "Por Mes": T√≠tulo visible pero contenido vac√≠o.
HTML generado: ~<div class="year-list"></div>~ sin contenido.
#+END_QUOTE

** Causa Ra√≠z

Hugo no estaba generando las p√°ginas de t√©rminos de taxonom√≠a autom√°ticamente. Solo generaba el √≠ndice principal (~/years/index.html~) pero no las p√°ginas individuales (~/years/2023/~).

** Soluci√≥n Implementada

Crear **secciones manuales** en lugar de depender solo de taxonom√≠as:

#+BEGIN_SRC bash
# Crear estructura de contenido
mkdir -p content/years content/months

# P√°gina de cada a√±o
cat > content/years/2023.md << 'EOF'
---
title: "2023"
year: 2023
---
EOF

# P√°ginas de cada mes (1-12)
for i in {1..12}; do
  cat > content/months/$i.md << EOF
---
title: "$i"
month: $i
---
EOF
done
#+END_SRC

Luego usar filtros en los templates:

#+BEGIN_SRC go-html-template
{{ $year := .Params.year }}
{{ $photos := where site.RegularPages "Section" "fotos" }}
{{ $yearPhotos := where $photos "Params.year" "eq" $year }}

{{ range $yearPhotos }}
  <!-- Mostrar foto -->
{{ end }}
#+END_SRC

** Archivos Creados

- ~content/years/_index.md~
- ~content/years/2023.md~
- ~content/years/2026.md~
- ~content/months/_index.md~
- ~content/months/1.md~ a ~content/months/12.md~
- ~layouts/years/list.html~
- ~layouts/years/single.html~
- ~layouts/months/list.html~
- ~layouts/months/single.html~

** Alternativa No Usada

Mantener solo taxonom√≠as en ~config.toml~ pero requer√≠a templates m√°s complejos:

#+BEGIN_SRC toml
[taxonomies]
  year = "years"
  month = "months"
#+END_SRC

** Lecci√≥n Aprendida

#+BEGIN_QUOTE
üóÇÔ∏è Para navegaci√≥n por atributos num√©ricos (a√±os, meses), es m√°s confiable crear secciones manuales que depender √∫nicamente de taxonom√≠as de Hugo.
#+END_QUOTE

* PROBLEMA 5: Script Batch Solo Procesaba 1 Foto

** S√≠ntoma

#+BEGIN_QUOTE
~./scripts/batch_upload.sh~ detectaba 75 fotos pero solo procesaba la primera y terminaba.
#+END_QUOTE

** Causa Ra√≠z

El bucle ~while~ con ~find~ y ~read~ ten√≠a problemas con el pipeline:

#+BEGIN_SRC bash
# INCORRECTO (solo procesa 1)
while IFS= read -r -d '' photo; do
    process_photo "$photo"
done < <(find "$folder_path" -name "*.jpg" -print0 | sort -z)
#+END_SRC

** Soluci√≥n Implementada

Usar bucle ~for~ con glob expansion:

#+BEGIN_SRC bash
# CORRECTO (procesa todas)
for foto in "$folder_path"/*.jpg "$folder_path"/*.JPG \
            "$folder_path"/*.jpeg "$folder_path"/*.JPEG \
            "$folder_path"/*.png "$folder_path"/*.PNG; do
    [ -f "$foto" ] || continue
    process_photo "$foto"
done
#+END_SRC

** Archivo Modificado

- ~scripts/batch_upload.sh~ (l√≠neas 210-230)

** Lecci√≥n Aprendida

#+BEGIN_QUOTE
üîÑ Los bucles ~for~ con globbing son m√°s confiables que ~while read~ con ~find~ para iterar sobre archivos, especialmente cuando hay m√∫ltiples extensiones.
#+END_QUOTE

* PROBLEMA 6: Formatos de Imagen Mixtos

** S√≠ntoma

#+BEGIN_QUOTE
Usuario tiene fotos en .jpg, .JPG, .jpeg, .JPEG, .png, .PNG y pregunta si debe procesarlas primero.
#+END_QUOTE

** Soluci√≥n Implementada

El script ya manejaba todos los formatos autom√°ticamente:

#+BEGIN_SRC bash
# Detectar formato (case-insensitive)
local extension="${photo_path##*.}"
extension=$(echo "$extension" | tr '[:upper:]' '[:lower:]')

if [[ ! "$extension" =~ ^(jpg|jpeg|png)$ ]]; then
    print_error "Formato no soportado"
    return
fi

# Convertir TODO a JPG optimizado
convert "$foto" -auto-orient \
    -resize "1920x1080>" \
    -quality 85 \
    "$output_full.jpg"
#+END_SRC

** Resultado

| Entrada          | Proceso                     | Salida               |
|------------------+-----------------------------+----------------------|
| IMG_001.JPG      | Optimizar ‚Üí JPG             | foto_xxx_full.jpg    |
| foto.png         | PNG‚ÜíJPG ‚Üí Optimizar         | foto_xxx_full.jpg    |
| PHOTO.JPEG       | Optimizar ‚Üí JPG             | foto_xxx_full.jpg    |
| screenshot.PNG   | PNG‚ÜíJPG (fondo blanco)      | foto_xxx_full.jpg    |

** Documentaci√≥n Creada

- ~GUIA_FORMATOS_IMAGEN.txt~ (4KB)

** Lecci√≥n Aprendida

#+BEGIN_QUOTE
üé® Unificar todos los formatos de entrada a un solo formato de salida (JPG) simplifica el mantenimiento y garantiza consistencia.
#+END_QUOTE

* PROBLEMA 7: Fechas EXIF Corruptas

** S√≠ntoma

#+BEGIN_QUOTE
El script se bloqueaba en la foto 58 con error:
~:00:00 00:00:00: syntax error: operand expected~
#+END_QUOTE

** Causa Ra√≠z

Algunas fotos ten√≠an metadata EXIF corrupta o vac√≠a, causando que la variable de fecha tuviera valores inv√°lidos.

** Soluci√≥n Implementada

Implementar fallbacks en cascada:

#+BEGIN_SRC bash
extract_exif_date() {
    local file="$1"
    
    # Intento 1: DateTimeOriginal
    local date=$(exiftool -d "%Y-%m-%d %H:%M:%S" \
                 -DateTimeOriginal -s3 "$file" 2>/dev/null)
    
    # Intento 2: CreateDate
    [ -z "$date" ] && date=$(exiftool -d "%Y-%m-%d %H:%M:%S" \
                             -CreateDate -s3 "$file" 2>/dev/null)
    
    # Intento 3: Fecha del archivo (filesystem)
    if [ -z "$date" ] || [[ "$date" =~ "0000:00:00" ]]; then
        date=$(stat -c "%y" "$file" 2>/dev/null | cut -d'.' -f1)
    fi
    
    # Intento 4: Validar formato
    if [[ ! "$date" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}\ [0-9]{2}:[0-9]{2}:[0-9]{2}$ ]]; then
        date="2024-01-01 12:00:00"  # Fecha por defecto
        echo "‚ö† Fecha inv√°lida, usando default" >&2
    fi
    
    echo "$date"
}
#+END_SRC

** Archivos Modificados

- ~scripts/manage_photos.sh~ (funci√≥n ~extract_exif_date~)
- ~scripts/batch_upload.sh~ (funci√≥n ~extract_exif_date~)

** Lecci√≥n Aprendida

#+BEGIN_QUOTE
üìÖ Siempre implementar m√∫ltiples fallbacks para metadata EXIF. La corrupci√≥n de datos es com√∫n en fotos de m√∫ltiples fuentes.
#+END_QUOTE

* DIAGRAMA: FLUJO DE RESOLUCI√ìN DE PROBLEMAS

#+BEGIN_SRC plantuml :file troubleshooting-flow.png :exports results
@startuml
!define PROBLEM #FFE0E0
!define SUCCESS #E0FFE0
!define WARNING #FFFFE0

skinparam backgroundColor #FEFEFE

start

:Usuario reporta problema;

partition "Diagn√≥stico" {
    :Reproducir localmente;
    
    if (¬øSe reproduce?) then (s√≠)
        :Verificar logs y errores;
        :Inspeccionar HTML generado;
        :Comparar local vs GitHub;
    else (no)
        :Problema espec√≠fico de entorno;
        stop
    endif
}

partition "Identificaci√≥n" {
    :Identificar causa ra√≠z;
    note right
        Herramientas:
        - Consola del navegador (F12)
        - Hugo --verbose
        - grep en archivos generados
        - Comparar working vs broken
    end note
}

partition "Soluci√≥n" {
    :Implementar fix;
    :Probar localmente primero;
    
    if (¬øFunciona local?) then (s√≠)
        :Commit y push;
        :Esperar GitHub Actions;
        :Probar en producci√≥n;
        
        if (¬øFunciona producci√≥n?) then (s√≠)
            :‚úì Problema resuelto;
            note right #E0FFE0
                Documentar en
                troubleshooting.org
            end note
            stop
        else (no)
            :Rollback;
            :Revisar diferencias;
        endif
    else (no)
        :Revisar implementaci√≥n;
    endif
}

@enduml
#+END_SRC

#+RESULTS:
[[file:troubleshooting-flow.png]]

* TABLA: PROBLEMAS Y SOLUCIONES RESUMEN

| # | Problema | Causa | Soluci√≥n | Tiempo |
|---+----------+-------+----------+--------|
| 1 | Auth no funciona HTTP | crypto.subtle bloqueado | Implementar SHA-256 puro JS | 30 min |
| 2 | CSS/JS no cargan GitHub | Rutas sin subdirectorio | Usar .Site.BaseURL | 45 min |
| 3 | Thumbnails vac√≠os | Rutas y templates | TrimPrefix + templates espec√≠ficos | 60 min |
| 4 | A√±os/Meses vac√≠os | Taxonom√≠as no generadas | Secciones manuales + filtros | 40 min |
| 5 | Batch solo 1 foto | Bucle while con find | Cambiar a for con glob | 20 min |
| 6 | Formatos mixtos | N/A (ya funcionaba) | Documentar proceso | 15 min |
| 7 | EXIF corrupto | Metadata inv√°lida | Fallbacks en cascada | 25 min |
|---+----------+-------+----------+--------|
| *TOTAL* |  |  |  | *4h 15min* |

* CHECKLIST DE VERIFICACI√ìN POST-DEPLOYMENT

Usar esta lista cada vez que se hace un deployment:

** Frontend (Usuario)

- [ ] Login funciona con password correcto
- [ ] P√°gina principal muestra thumbnails
- [ ] Click en thumbnail abre foto individual
- [ ] Foto individual muestra imagen full
- [ ] Bot√≥n "Descargar" funciona
- [ ] Navegaci√≥n "Por A√±o" muestra tarjetas
- [ ] Click en a√±o muestra fotos con thumbnails
- [ ] Navegaci√≥n "Por Mes" muestra tarjetas
- [ ] Click en mes muestra fotos con thumbnails
- [ ] "Todas las Fotos" muestra lista completa
- [ ] Bot√≥n "Cerrar Sesi√≥n" funciona

** Backend (T√©cnico)

- [ ] GitHub Actions complet√≥ sin errores (‚úÖ)
- [ ] Hugo gener√≥ n√∫mero correcto de p√°ginas
- [ ] Assets (CSS/JS/im√°genes) cargan correctamente
- [ ] URLs no tienen doble barra (~//~)
- [ ] Consola del navegador sin errores (F12)
- [ ] Responsive funciona (m√≥vil/tablet/desktop)

** Automatizaci√≥n

- [ ] Cron job configurado (~crontab -l~)
- [ ] Script ~weekly_deploy.sh~ ejecutable
- [ ] Logs se crean correctamente
- [ ] Backups se generan

* COMANDOS √öTILES PARA DEBUGGING

#+BEGIN_SRC bash
# Ver qu√© genera Hugo
hugo --cleanDestinationDir --verbose

# Buscar rutas problem√°ticas
grep -r "mcasrom.github.io" public/ | grep -v "recuerdos-familia"

# Ver estructura generada
find public/ -name "*.html" | head -20

# Verificar thumbnails en HTML
grep "_thumb.jpg" public/index.html | head -5

# Probar localhost sin cach√©
hugo server --baseURL "" --disableFastRender --noHTTPCache

# Ver logs de cron
grep CRON /var/log/syslog | grep album

# Verificar tama√±o de im√°genes
find static/images -name "*_full.jpg" -exec du -h {} \; | sort -h

# Contar fotos por a√±o
for year in static/images/*/; do
    year=$(basename "$year")
    echo "$year: $(find static/images/$year -name "*_full.jpg" | wc -l)"
done
#+END_SRC

* LECCIONES APRENDIDAS GENERALES

** Desarrollo Web

1. *Siempre probar en el entorno real*: Local ‚â† Producci√≥n
2. *URLs absolutas para GitHub Pages*: Subdirectorios requieren baseURL
3. *Fallbacks para browser APIs*: crypto.subtle, localStorage, etc.
4. *Clear cache aggressively*: ~Ctrl+Shift+R~ es tu amigo

** Hugo Espec√≠fico

1. *Templates espec√≠ficos > defaults*: Crear layouts por secci√≥n
2. *Verificar el HTML generado*: ~public/~ es la verdad
3. *Taxonom√≠as son complejas*: A veces secciones manuales son m√°s simples
4. *Globbing > find*: Para iterar archivos, for es m√°s confiable

** Gesti√≥n de Proyecto

1. *Documentar mientras trabajas*: No despu√©s
2. *Un problema a la vez*: No hacer m√∫ltiples cambios simult√°neos
3. *Git commits peque√±os*: Facilita rollback
4. *Probar localmente primero*: Ahorra tiempo de CI/CD

* RECURSOS ADICIONALES

** Documentaci√≥n Oficial

- Hugo: https://gohugo.io/documentation/
- GitHub Pages: https://docs.github.com/pages
- GitHub Actions: https://docs.github.com/actions

** Archivos del Proyecto

- ~ALBUM_FAMILIAR_HOWTO.org~: Gu√≠a completa de uso
- ~ALBUM_FAMILIAR_DOCUMENTATION.org~: Documentaci√≥n t√©cnica
- ~README.md~: Inicio r√°pido
- ~GUIA_STORAGE_FOTOS.txt~: C√≥mo organizar fotos
- ~GUIA_FORMATOS_IMAGEN.txt~: Formatos soportados
- ~TODO.org~: Mejoras futuras

** Scripts Cr√≠ticos

| Script | Prop√≥sito | Frecuencia |
|--------+-----------+------------|
| ~setup.sh~ | Instalaci√≥n inicial | Una vez |
| ~manage_photos.sh~ | Subir fotos individuales | Manual |
| ~batch_upload.sh~ | Subir m√∫ltiples fotos | Manual |
| ~deploy.sh~ | Deployment manual | Manual |
| ~weekly_deploy.sh~ | Deployment autom√°tico | Semanal (cron) |
| ~backup_album.sh~ | Backup manual | Manual |

* CONTACTO Y SOPORTE

Para problemas o mejoras:

1. Revisar este documento primero
2. Verificar logs: ~tail -f ~/album_familiar/logs/*.log~
3. Comparar con versi√≥n funcional conocida
4. Consultar ~ALBUM_FAMILIAR_HOWTO.org~

* VERSI√ìN Y CHANGELOG

| Versi√≥n | Fecha | Cambios |
|---------+-------+---------|
| 1.0 | 2026-02-14 | Versi√≥n inicial funcional |
| 1.1 | 2026-02-15 | Correcci√≥n thumbnails y taxonom√≠as |

---

*Fin del documento de troubleshooting*

# Local Variables:
# org-confirm-babel-evaluate: nil
# End:
